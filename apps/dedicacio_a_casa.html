<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comptador d'Hores de Feina Domèstica</title>
    <!-- Càrrega de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Fons més clar */
        }
        .time-display {
            font-size: 3.5rem;
            font-weight: 800;
            letter-spacing: -1px;
        }
        .card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-2xl card p-6 sm:p-10 rounded-xl">
        
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">
            Monitor de Temps de Treball
        </h1>
        <p class="text-center text-sm text-gray-500 mb-8">
            Porta el compte de les teves hores de feina domèstica. (Dades guardades localment)
        </p>

        <!-- Display per al Comptador Total i Control -->
        <div class="md:flex md:space-x-6">
            
            <!-- Columna Esquerra: Temps Total i Control -->
            <div class="flex-1 bg-blue-50 p-6 rounded-lg mb-6 md:mb-0 text-center border border-blue-200">
                <p class="text-blue-700 text-lg font-medium">Temps Total Acumulat</p>
                <div id="total-time-display" class="time-display text-blue-900">00:00:00</div>
                <p id="status-message" class="text-sm text-gray-600 mt-2 h-5">Carregant...</p>

                <!-- Botó de Control -->
                <div class="flex justify-center mt-4 mb-4">
                    <button id="start-stop-button" 
                            onclick="startStopTimer()"
                            class="px-8 py-3 text-lg font-semibold rounded-full shadow-lg transition duration-200 
                                focus:outline-none focus:ring-4 focus:ring-opacity-50 w-full md:w-auto
                                bg-green-600 text-white hover:bg-green-700 focus:ring-green-300">
                        Iniciar
                    </button>
                </div>

                <!-- Botons d'Ajust Manual i Reiniciar -->
                <div class="flex justify-center space-x-2 sm:space-x-4 mt-4">
                    <button onclick="adjustTime(900000)" 
                            class="bg-yellow-500 text-white px-3 sm:px-4 py-2 rounded-full font-bold text-sm shadow-md hover:bg-yellow-600 transition"
                            title="Afegir 15 minuts (+900000 ms)">
                        + 15'
                    </button>
                    <button onclick="adjustTime(-900000)" 
                            class="bg-yellow-500 text-white px-3 sm:px-4 py-2 rounded-full font-bold text-sm shadow-md hover:bg-yellow-600 transition"
                            title="Restar 15 minuts (-900000 ms)">
                        - 15'
                    </button>
                    <button onclick="resetData()" 
                            class="bg-gray-400 text-white px-3 sm:px-4 py-2 rounded-full font-bold text-sm shadow-md hover:bg-gray-500 transition"
                            title="Reiniciar tot el comptador">
                        Reiniciar
                    </button>
                </div>

            </div>

            <!-- Columna Dreta: Objectiu i Comparació -->
            <div class="flex-1 pt-6 md:pt-0">
                <p class="text-lg font-semibold text-gray-700 mb-3">
                    Treball a casa: <span class="text-blue-600">14:00:00</span>
                </p>
                
                <div id="comparison-display" class="p-4 rounded-lg text-center shadow-inner border">
                    <p id="diff-label" class="text-md font-medium text-gray-600">Temps restant per no sobrepassar el limit del que cobres:</p>
                    <p id="diff-value" class="text-2xl font-bold mt-1 text-gray-800">--:--:--</p>
                </div>

                <!-- Mitjana Diària -->
                <div class="mt-4 p-4 rounded-lg text-center shadow-inner border bg-gray-50">
                    <p class="text-md font-medium text-gray-600">Mitjana Diària:</p>
                    <p id="daily-average-display" class="text-2xl font-bold mt-1 text-purple-600">00:00:00</p>
                </div>
            </div>
        </div>

        <!-- Secció: Temps Diari i Log -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Temps Diari Registrat</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avui és</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dia</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Temps (h:m:s)</th>
                        </tr>
                    </thead>
                    <tbody id="daily-log-body" class="bg-white divide-y divide-gray-200">
                        <!-- Les files es generaran aquí -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        // Clau de localStorage per a guardar l'objecte de dades de l'app
        const LOCAL_STORAGE_KEY = 'workTrackerAppData';

        // Estat de l'aplicació
        let appData = {
            totalTimeMs: 0,
            dailyEntries: {} // Clau: 'YYYY-MM-DD', Valor: ms per a aquest dia
        };
        let isRunning = false;
        let startTime = 0;
        let intervalId = null;

        // Constant per a l'objectiu de 14 hores (14 * 60 * 60 * 1000 ms)
        const TARGET_MS = 14 * 60 * 60 * 1000; 
        const MIN_15_MS = 15 * 60 * 1000; // 15 minuts en milisegons

        // Referències del DOM
        const totalTimeDisplay = document.getElementById('total-time-display');
        const startStopButton = document.getElementById('start-stop-button');
        const comparisonDisplay = document.getElementById('comparison-display');
        const diffValueDisplay = document.getElementById('diff-value');
        const diffLabelDisplay = document.getElementById('diff-label');
        const statusMessage = document.getElementById('status-message');
        const dailyLogBody = document.getElementById('daily-log-body');
        const dailyAverageDisplay = document.getElementById('daily-average-display');

        // Noms dels dies de la setmana en català (per a renderitzar la taula)
        const dayNames = ['Diumenge', 'Dilluns', 'Dimarts', 'Dimecres', 'Dijous', 'Divendres', 'Dissabte'];

        // --- Utilitats de Temps i Data ---

        /**
         * Retorna la data actual en format YYYY-MM-DD.
         * @returns {string} La data d'avui.
         */
        function getTodayKey() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Converteix milisegons a format HH:MM:SS.
         * @param {number} ms - Temps en milisegons.
         * @returns {string} - Cadena de temps formatada.
         */
        function formatTime(ms) {
            const absoluteMs = Math.abs(ms);
            const totalSeconds = Math.floor(absoluteMs / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const sign = ms < 0 ? '-' : '';

            return sign + 
                   String(hours).padStart(2, '0') + ':' +
                   String(minutes).padStart(2, '0') + ':' +
                   String(seconds).padStart(2, '0');
        }

        /**
         * Actualitza el comptador principal i el càlcul de la diferència.
         */
        function updateDisplay() {
            // 1. Calcular el temps actual total
            let currentTimeMs = appData.totalTimeMs;
            if (isRunning) {
                currentTimeMs += (Date.now() - startTime);
            }
            
            // 2. Actualitzar el temps total
            totalTimeDisplay.textContent = formatTime(currentTimeMs);

            // 3. Calcular i actualitzar la diferència
            const differenceMs = currentTimeMs - TARGET_MS;
            diffValueDisplay.textContent = formatTime(differenceMs);

            if (differenceMs >= 0) {
                // Si el temps és major o igual a 14h
                comparisonDisplay.classList.remove('border-green-300', 'border-yellow-300');
                comparisonDisplay.classList.add('border-red-500');
                diffLabelDisplay.textContent = 'Has superat l\'objectiu setmanal per:';
                diffValueDisplay.classList.remove('text-green-600', 'text-yellow-600');
                diffValueDisplay.classList.add('text-red-600');
            } else {
                // Si el temps és menor a 14h
                comparisonDisplay.classList.remove('border-red-500', 'border-yellow-300');
                comparisonDisplay.classList.add('border-green-300');
                // TEXT SOL·LICITAT: Temps restant per no sobrepassar el limit del que cobres:
                diffLabelDisplay.textContent = 'Temps restant per no sobrepassar el limit del que cobres:';
                diffValueDisplay.classList.remove('text-red-600', 'text-yellow-600');
                diffValueDisplay.classList.add('text-green-600');
            }
        }
        
        // --- Càlculs i Renderitzat de Log Diari ---

        /**
         * Calcula i actualitza la mitjana diària i el log visual.
         */
        function renderDailyLogAndAverage() {
            dailyLogBody.innerHTML = '';
            
            const daysData = appData.dailyEntries;
            const dates = Object.keys(daysData).sort((a, b) => new Date(a) - new Date(b));
            let totalTimeLogged = 0;
            let daysWorked = 0;
            const todayKey = getTodayKey();

            // Mapejar les dates a dies de la setmana i agrupar
            const dailySummary = {};
            dates.forEach(dateKey => {
                const date = new Date(dateKey);
                // 0 = Diumenge, 1 = Dilluns, etc.
                const dayIndex = date.getDay(); 
                const dayName = dayNames[dayIndex];
                const timeMs = daysData[dateKey];

                // Només comptem temps si és > 0
                if (timeMs > 0) {
                    // Acumular el temps diari per calcular la mitjana
                    totalTimeLogged += timeMs;
                    daysWorked++;
                }

                // Generar la taula de log
                const isToday = dateKey === todayKey;
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Marcar el dia d'avui
                const todayCell = document.createElement('td');
                todayCell.className = 'px-3 py-3 whitespace-nowrap text-sm font-medium';
                todayCell.textContent = isToday ? '✅' : '';

                const dayCell = document.createElement('td');
                dayCell.className = 'px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900';
                dayCell.textContent = dayName;

                const timeCell = document.createElement('td');
                timeCell.className = 'px-3 py-3 whitespace-nowrap text-sm text-gray-500 text-right font-mono';
                timeCell.textContent = formatTime(timeMs);

                row.appendChild(todayCell);
                row.appendChild(dayCell);
                row.appendChild(timeCell);
                dailyLogBody.appendChild(row);
            });
            
            // Càlcul de la Mitjana Diària
            const averageMs = daysWorked > 0 ? totalTimeLogged / daysWorked : 0;
            dailyAverageDisplay.textContent = formatTime(averageMs);
        }

        // --- Funcions de LocalStorage ---

        /**
         * Càrrega les dades de l'aplicació des de localStorage.
         */
        function loadTimeFromLocalStorage() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    // Comprovar que el format sigui el que esperem
                    if (typeof parsedData.totalTimeMs === 'number' && typeof parsedData.dailyEntries === 'object') {
                        appData = parsedData;
                        statusMessage.textContent = 'Dades carregades des de la memòria del navegador.';
                    } else {
                        // Si el format és incorrecte, inicialitzar
                        console.error('Error: Format de dades local incorrecte. Reiniciant.');
                        statusMessage.textContent = 'Error: Format de dades local incorrecte. Reiniciant.';
                    }
                } catch (e) {
                    console.error('Error parsejant dades de localStorage:', e);
                    statusMessage.textContent = 'Error: Dades locals corruptes. Reiniciant.';
                }
            } else {
                statusMessage.textContent = 'Comptador llest.';
            }
            updateDisplay(); // Actualitzar el total
            renderDailyLogAndAverage(); // Actualitzar el log i la mitjana
        }

        /**
         * Guarda l'objecte complet de dades de l'aplicació a localStorage.
         */
        function saveTimeTolocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData));
            console.log("Dades guardades a LocalStorage:", appData);
        }


        // --- Lògica del Contador ---

        function startTimer() {
            if (isRunning) return;

            isRunning = true;
            startTime = Date.now();

            startStopButton.textContent = 'Aturar';
            startStopButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-300');
            startStopButton.classList.add('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-300');
            statusMessage.textContent = 'Comptador actiu...';

            // El comptador s'actualitza cada segon
            intervalId = setInterval(updateDisplay, 1000);
        }

        function stopTimer() {
            if (!isRunning) return;

            const todayKey = getTodayKey();

            // 1. Calcular el temps transcorregut
            const elapsedTime = Date.now() - startTime;
            
            // 2. Afegir-lo al total acumulat
            appData.totalTimeMs += elapsedTime;
            
            // 3. Afegir-lo al log diari (inicialitzar si cal)
            if (!appData.dailyEntries[todayKey]) {
                appData.dailyEntries[todayKey] = 0;
            }
            appData.dailyEntries[todayKey] += elapsedTime;
            
            // 4. Detenir l'interval d'actualització
            clearInterval(intervalId);
            intervalId = null;
            isRunning = false;
            
            // 5. Guardar el nou total
            saveTimeTolocalStorage(); 
            
            // 6. Actualitzar la interfície
            updateDisplay();
            renderDailyLogAndAverage();
            startStopButton.textContent = 'Continuar';
            startStopButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-300');
            startStopButton.classList.add('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-300');
            statusMessage.textContent = 'Aturat. El teu temps ha estat guardat localment!';
        }

        window.startStopTimer = function() {
            if (isRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }
        
        /**
         * Afegeix o resta temps al total acumulat i al registre diari.
         * @param {number} ms - Milisegons a afegir/restar (p.ex., 900000 per +15').
         */
        window.adjustTime = function(ms) {
            if (isRunning) {
                // Si està corrent, s'ha de pausar i guardar primer l'elapsed time
                statusMessage.textContent = 'Atura el comptador abans d\'ajustar manualment.';
                return;
            }

            const todayKey = getTodayKey();
            
            // 1. Ajustar el total general
            appData.totalTimeMs += ms;
            
            // 2. Ajustar el log diari
            if (!appData.dailyEntries[todayKey]) {
                appData.dailyEntries[todayKey] = 0;
            }
            appData.dailyEntries[todayKey] += ms;
            
            // 3. Limitar a temps positiu (opcional, però evita totals negatius)
            if (appData.totalTimeMs < 0) appData.totalTimeMs = 0;
            if (appData.dailyEntries[todayKey] < 0) appData.dailyEntries[todayKey] = 0;

            // 4. Guardar i actualitzar la vista
            saveTimeTolocalStorage();
            updateDisplay();
            renderDailyLogAndAverage();
            statusMessage.textContent = ms > 0 ? `S'han afegit ${ms / 60000} minuts.` : `S'han restat ${Math.abs(ms) / 60000} minuts.`;
        }

        /**
         * Reinicia totes les dades del comptador (temps total i log diari).
         */
        window.resetData = function() {
            if (isRunning) {
                statusMessage.textContent = 'Atura el comptador abans de reiniciar.';
                return;
            }
            
            // Reiniciar l'estat de l'aplicació
            appData.totalTimeMs = 0;
            appData.dailyEntries = {};
            
            // Guardar l'estat reiniciat
            saveTimeTolocalStorage();
            
            // Actualitzar la interfície
            updateDisplay();
            renderDailyLogAndAverage();
            
            statusMessage.textContent = 'Comptador reiniciat a 00:00:00.';
        }


        // --- Inicialització ---
        
        function initializeApp() {
            // 1. Carregar dades des de localStorage
            loadTimeFromLocalStorage();
            
            // 2. Tots els esdeveniments es gestionen amb onclick
        }

        // Iniciar tot al carregar la finestra
        window.onload = initializeApp;
        
    </script>
</body>
</html>